<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="referrer" content="origin" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Subscription Payment</title>
  <style>
    /* Full‑page setup */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: #f9f9f9;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    #resultMsg p {
      margin: 0.5em 0;
      word-wrap: break-word;
      padding: 0 10px;
    }
    iframe {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      border: none;
    }
  </style>
</head>
<body>
  <h2>Processing Your Subscription…</h2>
  <div id="resultMsg"></div>

  <script>
    function showMessage(msg, isError = false) {
      console.log(`showMessage (isError: ${isError}): ${msg}`);
      const color = isError ? 'red' : 'green';
      const resultDiv = document.getElementById('resultMsg');
      if (resultDiv) {
        resultDiv.innerHTML = `<p style="color:${color}">${msg}</p>`;
      }
    }

    function loadJQuery() {
      const jq = document.createElement('script');
      jq.src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js";
      jq.onload = loadPaypleScript;
      jq.onerror = () => showMessage('Error loading jQuery.', true);
      document.head.appendChild(jq);
    }

    function loadPaypleScript() {
      const pp = document.createElement('script');
      pp.src = "https://demo-gpay.payple.kr/common/js/gpay-1.0.1.js";
      pp.onload = initPayment;
      pp.onerror = () => showMessage('Error loading Payple script.', true);
      document.head.appendChild(pp);
    }

    async function initPayment() {
      showMessage('Initializing payment...', false);
      try {
        const params = new URLSearchParams(location.search);
        const amount = params.get('amount');
        const orderId = params.get('orderId');
        const userId = params.get('userId');
        if (!amount || !orderId || !userId) {
          throw new Error('Missing amount, orderId, or userId in URL.');
        }

        showMessage('Authenticating...', false);
        const authRes = await fetch('/api/getPaypleAuthToken');
        if (!authRes.ok) throw new Error('Failed to fetch auth token');
        const authData = await authRes.json();
        const token = authData.PCD_AUTH_KEY;
        if (!token) throw new Error('No auth key returned');

        showMessage('Preparing payment window…', false);
        const cfg = {
          Authorization: token,
          service_id: 'demo',
          payCls: 'demo',
          PCD_PAY_OID: orderId,
          totalAmount: amount,
          currency: 'KRW',
          resultUrl: `${location.origin}/api/callback?userId=${encodeURIComponent(userId)}`,
          PCD_REGULER_FLAG: 'Y',
          PCD_CARD_VER: '01',
          PCD_AUTH_TYPE: 'CERT',
          PCD_SIMPLE_FLAG: 'Y',
          PCD_PAY_GOODS: 'Monthly Subscription'
        };

        if (typeof paypleGpayPaymentRequest === 'function') {
          paypleGpayPaymentRequest(cfg);
          showMessage('Loading payment interface...', false);
        } else {
          showMessage('Payment function not available.', true);
        }
      } catch (err) {
        console.error(err);
        showMessage(`Error: ${err.message}`, true);
      }
    }

    document.addEventListener('DOMContentLoaded', loadJQuery);
  </script>
</body>
</html>
